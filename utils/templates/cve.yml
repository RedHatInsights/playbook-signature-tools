- name: update vulnerable packages
  hosts: '@@HOSTS@@'
  vars:
    insights_issues: '@@ISSUES@@'
    insights_signature_exclude: /hosts,/vars/insights_issues,/vars/insights_signature
    insights_signature: !!binary |
      SFQ0R2YrR2YzM05sNnFpbmptWWtGcXNnNVEvbitZYWgzZXYvTHpHb1dNS3lHR2J2NkFKb0NveFkx
      K2RvM0VaSW42Skl5Z1RxaTlzR0JqeFJrcG41eFZnMkJ6QWdEdm1NS29vVXRGL1h3ZFl5ZTRlemxE
      d2psWENmNktLWHhiaGx1ZVZrdjVCYXVJMnBmWXNEYXZuMTZidzNWZXMwcXF6TkQzQXUzaWtBNm9G
      bHNIamlJNjhFMUFyUExaeVpxZUx4cFJMRnRFWXVnUjBySmUzK0x5Y0c1cGQ4dmNLa25tM2hwODln
      RklXSmtab25kYkh4RDRVRW80cFB3YUxIaHVRRng5Z0M2blFrSmZxMUMzeUxIc1NXekpLME5KaEhh
      djlsVERwMFlySmxWVnN1MnhhVjlBY2huR25rMWZ5bDFRUEpad3Q3ZkFLeTVhUFJxTS9sUmloTENB
      PT0=
  become: true
  tasks:
    - name: check for update
      shell: '{{ ansible_facts[''pkg_mgr''] }} check-update -q --cve {{ insights_issues }}'
      check_mode: false
      register: check_out
      failed_when: check_out.rc != 0 and check_out.rc != 100
      args:
        warn: false
    - when: check_out.rc == 100
      name: upgrade package
      shell: '{{ ansible_facts[''pkg_mgr''] }} upgrade -v -y --cve {{ insights_issues }}'
      args:
        warn: false
    - when: check_out.rc == 100
      name: set reboot fact
      set_fact:
        insights_needs_reboot: true
