---
# Red Hat Insights has recommended one or more actions for you, a system administrator, to review and if you
# deem appropriate, deploy on your systems running Red Hat software. Based on the analysis, we have automatically
# generated an Ansible Playbook for you. Please review and test the recommended actions and the Playbook as
# they may contain configuration changes, updates, reboots and/or other changes to your systems. Red Hat is not
# responsible for any adverse outcomes related to these recommendations or Playbooks.
#
# Test_signing_3
# https://cloud.redhat.com/insights/remediations/695e5b66-a065-416e-8372-426eb01b6334
# Generated by Red Hat Insights on Sun, 07 Feb 2021 02:12:59 GMT
# Created by rhn-support-lichen

# Kernel panic might occur when using the SELINUX&#x3D;disabled option in the &#x2F;etc&#x2F;selinux&#x2F;config
# Identifier: (advisor:selinux_disabled_kernel_panic|SELINUX_DISABLED_KERNEL_PANIC,boot_cmdline)
# Version: 79af563052ab0187e75cc71cda1479d2cf9d6512
- name: Disable SELinux by adding the selinux=0 parameter to the kernel command line
  hosts: newpreview,team-jupyter-server
  become: true
  vars:
    insights_signature_exclude: /hosts,/vars/insights_signature
    insights_signature: !!binary |
      TFMwdExTMUNSVWRKVGlCUVIxQWdVMGxIVGtGVVZWSkZMUzB0TFMwS0NtbFJSWHBDUVVGQ1EwRkJa
      RVpwUlVWQmMzVTJTbWsxYkhoUlpqTlRkVTgyT1U0ek1WWXdZMUU1U1RCR1FXMUJlblYyV1VGRFoy
      dFJPVTR6TVZZd1kxRUtPVWt5THl0QlppdE9XVXBUTDA5NFVrdDBkR1V3VTAxTGIzUXlURU4yY0ho
      clVsWk9WR2g2WW5sa2IwNHpTRTF6WTJJMmVXbFJabkJNVEVadGEyOVpRUXBoV1RCcldUTkRZVlJH
      Tm1NMVZsaDVlVkJOVTJoTFIzTlBabU5UVFRadWFERkRlR2hVYUU1VmNqRjRSVmRoTmtkSWFqQjZS
      V0ZzVEhGeU5XTjNhMGt6Q2xwaWFrUm1UMWwwVFdadVRGZHpNMGQzSzA1SE0waEdRVXc1UlV4eGMy
      bFZWMDl3TjB0eVZYbEJiVXhVT0ZSTFJWVllZekEwV1hWQ2VtcFlMMVphTjFJS2JXOWxUbTV6WmpW
      QldEQmljemx6U2xObWFtdEJjVzEzY3pCYWJYQndialprTDB0YVFUUnVlV2d3TjFOMmJtNVBjalZU
      Tm1aMVYyNXNZMmxCYm14V1ZRb3lNVUpDVUd0UVdVOU5SMlpLVFhJdlRtSjZjbVJNVGpkMGVtRnlW
      MlJ4WVhKek9TczJSSEZRY1N0MFpVMUtPWFpFYld4NVYxaDBSRTlOTjFWbk1WTXdDbHBaYmpBMFkx
      RnplVFJ5WVZwdlJqUXZjMUJLVldaTGJTOTJUMk5sVVQwOUNqMXBVV2h2Q2kwdExTMHRSVTVFSUZC
      SFVDQlRTVWRPUVZSVlVrVXRMUzB0TFFvPQ==
  tasks:
    - name: Add selinux=0 to kernel command line
      command: grubby --update-kernel=ALL --args="selinux=0"
      register: grub_change
      changed_when: grub_change.rc == 0
    - when: grub_change is changed
      name: set reboot fact
      set_fact:
        insights_needs_reboot: true


# Reboots a system if any of the preceeding plays sets the 'insights_needs_reboot' variable to true.
# The variable can be overridden to suppress this behavior.
- name: Reboot system (if applicable)
  hosts: newpreview,team-jupyter-server
  vars:
    insights_signature_exclude: /hosts,/vars/insights_signature
    insights_signature: !!binary |
      TFMwdExTMUNSVWRKVGlCUVIxQWdVMGxIVGtGVVZWSkZMUzB0TFMwS0NtbFJSWHBDUVVGQ1EwRkJa
      RVpwUlVWQmMzVTJTbWsxYkhoUlpqTlRkVTgyT1U0ek1WWXdZMUU1U1RCR1FXMUJlblYwVVVGRFoy
      dFJPVTR6TVZZd1kxRUtPVWt6VGtaUlowRnRXVlZEWVdkTFdWVnNlVWhzSzNObmNFUTRhSEZsS3pk
      M05WbDNTMlJFVVRCc1RVWmthVWhET0M5UFREWkhNVEJuVjFCNk5uUTRad3B6Um01R1NHZEVORk5v
      V2pkVmFHRTRjbnB0YVVJd1EzWnhORkpWT1U5a1NHcFlkWEJXZW1GMlNtNUlOWE51ZGpsM2RGaFFh
      V0ZGZUZReVVXZFhUSFZNQ210MlVUaDJSRXd6TjFaUE4zbFFZWGRTY0hsNk1GbzNjVmhsTjJKaE5r
      MU1jRXhYVG1VdlVFVlBhelkxUVZodGNrNXZhRmt3ZVdwM2FEQnZTM052TDFRS1ZsaHJMeXRSVmtN
      M05HZFFabUkwZHpaQmJsZFlkV0o1VGxWbFRXSkpiSG8xZW5oR05qUjRka3N6ZFhKRlVUWkNabnA2
      UVZZMVMwTnlka2g2T0dsYU5nbzVLMWMxZUd4Q1VqQkRNVkIzVmxsRWJVeFRaMFpVVnpSeFNFaEVh
      R280YlVNck1UVjFNRmRZTHlzNVYyZDVRWEZTV0ZCcWMwcGxSR016V2tRM1YySmpDbnBsVGxsbVJs
      bHdTRzlwTm1GdVdUTlZjSEI1ZUV3MFZWWkxVR1J5UVQwOUNqMWxZMHh6Q2kwdExTMHRSVTVFSUZC
      SFVDQlRTVWRPUVZSVlVrVXRMUzB0TFFvPQ==
  become: true
  gather_facts: false
  tasks:
    - when:
        - insights_needs_reboot is defined
        - insights_needs_reboot
      block:
        - name: Reboot system
          shell: sleep 2 && shutdown -r now "Ansible triggered reboot"
          async: 1
          poll: 0
          ignore_errors: true
        - name: Wait for system to boot up
          local_action:
            module: wait_for
            host: '{{ hostvars[inventory_hostname][''ansible_host''] | default(hostvars[inventory_hostname][''ansible_ssh_host''],
              true) | default(inventory_hostname, true) }}'
            port: '{{ hostvars[inventory_hostname][''ansible_port''] | default(hostvars[inventory_hostname][''ansible_ssh_port''],
              true) | default(''22'', true) }}'
            delay: 15
            search_regex: OpenSSH
            timeout: 300
          become: false

- name: run insights
  hosts: newpreview,team-jupyter-server
  vars:
    insights_signature_exclude: /hosts,/vars/insights_signature
    insights_signature: !!binary |
      TFMwdExTMUNSVWRKVGlCUVIxQWdVMGxIVGtGVVZWSkZMUzB0TFMwS0NtbFJSWHBDUVVGQ1EwRkJa
      RVpwUlVWQmMzVTJTbWsxYkhoUlpqTlRkVTgyT1U0ek1WWXdZMUU1U1RCR1FXMUJlblYzZDBGRFoy
      dFJPVTR6TVZZd1kxRUtPVWt6ZFhaQlppdE5PVFpCUkRScU1tRndkMHBvY2pGeGVHZGFjRkZKVEc5
      cFNFOVlTRFY2YVV4bVdISktiR2RzUm5oU1ZESktRVWgzTDNWaVNURlhVUW81WmxJM1NUWjZaelpw
      VkdGQlpuZDFWM0J1VDNJNWVIWkhXVEF6WTBKR1dtZHliMUZYTWtOeFdsZE1abXRoUzFkclNGRkpX
      RGh0UWpSaFFuQjVTMkpDQ2pGQlJuRnFPRUU1TXpneVoxQXhRWE15TWtsdlJpdFZTSHBCYmpJM2Ns
      TkRhSGQ1YXpCUGVtZHhiMWxMTm5ocVpESjJUV3BsUVN0T1N6WlBSRUl5TjFJS04zcG1UVmhOYWtS
      a1N6ZE9SMDF6UldSTWRXaEtaVlp5VldaUFNpdElSa3BVY25oMkwxUjVkRkZLYVhOSlRHTjBaMHc1
      WmxGR2FWcHBjbmQyVmxkaFJRcHRZbkF4TUVkdVVFcHNOR2RhYTFkNVltbEJlbFl6WmpOWFIzcEpR
      MnhQVERKNWNVWllPR3BPTVhaeVdWVTJiak56VFRBM1NETTFhMkpzT1VOdk4xcERDakEyU25oeE5E
      TklRWEpxZWs4NWVYaG5RMnBRVlRGMlMzWnJUbHBhWnowOUNqMHhabkpGQ2kwdExTMHRSVTVFSUZC
      SFVDQlRTVWRPUVZSVlVrVXRMUzB0TFFvPQ==
  become: true
  gather_facts: false
  tasks:
    - name: run insights
      command: insights-client
      changed_when: false
